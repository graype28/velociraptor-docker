#!/bin/bash
set -e
BIND_ADDRESS="0.0.0.0"
PUBLIC_PATH="public"
LOG_DIR="."
DATASTORE_LOCATION="./"
FILESTORE_DIRECTORY="./"
CLIENT_DIR="/velociraptor/clients"

# Move binaries into place
cp /opt/velociraptor/linux/velociraptor . && chmod +x velociraptor
mkdir -p $CLIENT_DIR/linux && rsync -a /opt/velociraptor/linux/velociraptor /velociraptor/clients/linux/velociraptor_client
mkdir -p $CLIENT_DIR/mac && rsync -a /opt/velociraptor/mac/velociraptor_client /velociraptor/clients/mac/velociraptor_client
mkdir -p $CLIENT_DIR/windows && rsync -a /opt/velociraptor/windows/velociraptor_client* /velociraptor/clients/windows/

# If no existing server config, set it up
if [ ! -f server.config.yaml ]; then
	# Set default values if environment variables are not set
	VELOX_USER=${VELOX_USER:-admin}
	VELOX_PASSWORD=${VELOX_PASSWORD:-password}
	VELOX_ROLE=${VELOX_ROLE:-administrator}
	VELOX_FRONTEND_HOSTNAME=${VELOX_FRONTEND_HOSTNAME:-localhost}
	VELOX_SERVER_URL=${VELOX_SERVER_URL:-https://localhost:8000/}
	
	echo "Generating server configuration..."
	echo "Frontend hostname: $VELOX_FRONTEND_HOSTNAME"
	echo "Server URL: $VELOX_SERVER_URL"
	
	# Generate base config first
	./velociraptor config generate > server.config.yaml
	
	# Update configuration with our settings
	sed -i 's#/tmp/velociraptor#.#'g server.config.yaml
	
	# Update the hostname in the config
	sed -i "s/hostname: localhost/hostname: $VELOX_FRONTEND_HOSTNAME/g" server.config.yaml
	
	# Update bind addresses to listen on all interfaces
	sed -i "s/bind_address: 127.0.0.1/bind_address: $BIND_ADDRESS/g" server.config.yaml
	sed -i "s/bind_address: localhost/bind_address: $BIND_ADDRESS/g" server.config.yaml
	
	# Update server URLs in client config section
	sed -i "s#https://localhost:8000/#$VELOX_SERVER_URL#g" server.config.yaml
	
	echo "Creating user: $VELOX_USER with role: $VELOX_ROLE"
	./velociraptor --config server.config.yaml user add "$VELOX_USER" "$VELOX_PASSWORD" --role "$VELOX_ROLE"
fi

# Check Server Certificate Status, Re-generate if it's expiring in 24-hours or less
if true | ./velociraptor --config server.config.yaml config show --json | jq -r .Frontend.certificate | openssl x509 -text -enddate -noout -checkend 86400 >/dev/null; then
  echo "Skipping renewal, certificate is not expired"
else
  echo "Certificate is expired, rotating certificate."
  ./velociraptor --config ./server.config.yaml config rotate_key > /tmp/server.config.yaml
  cp ./server.config.yaml ./server.config.yaml.bak
  mv /tmp/server.config.yaml /velociraptor/.
fi

# Re-generate client config in case server config changed
./velociraptor --config server.config.yaml config client > client.config.yaml

# Repack clients
./velociraptor config repack --exe clients/linux/velociraptor_client client.config.yaml clients/linux/velociraptor_client_repacked
./velociraptor --config client.config.yaml debian client --output clients/linux/velociraptor_client_repacked.deb
./velociraptor --config client.config.yaml rpm client --output clients/linux/velociraptor_client_repacked.rpm
./velociraptor config repack --exe clients/mac/velociraptor_client client.config.yaml clients/mac/velociraptor_client_repacked
./velociraptor config repack --exe clients/windows/velociraptor_client.exe client.config.yaml clients/windows/velociraptor_client_repacked.exe
./velociraptor config repack --msi clients/windows/velociraptor_client.msi client.config.yaml clients/windows/velociraptor_client_repacked.msi

# Start Velocoraptor
./velociraptor --config server.config.yaml frontend -v
